#!/usr/bin/env bash
#
# Most-Used Apps Launcher
# Shows top 10 most-used applications from the past 7 days
# Uses Walker in dmenu mode for Omarchy-style menu
#

# Database location
DB_PATH="$HOME/.local/share/app-tracker/usage.db"

# Check if database exists
if [ ! -f "$DB_PATH" ]; then
    notify-send "App Tracker" "No usage data found. Start app-tracker first."
    exit 1
fi

# Get app icon from app-icons.sh if available
get_app_icon() {
    local app_name="$1"

    # Try to use the existing app-icons script
    if [ -f "$HOME/.config/waybar/scripts/app-icons.sh" ]; then
        icon=$("$HOME/.config/waybar/scripts/app-icons.sh" "$app_name")
        if [ -n "$icon" ] && [ "$icon" != "" ]; then
            echo "$icon"
            return
        fi
    fi

    # Fallback icons
    case "${app_name,,}" in
        alacritty|kitty|ghostty|*term*) echo "" ;;
        chromium|chrome|google-chrome) echo "" ;;
        firefox) echo "" ;;
        code|vscode|cursor) echo "" ;;
        spotify) echo "" ;;
        obs*) echo "" ;;
        discord) echo "󰙯" ;;
        slack) echo "" ;;
        telegram) echo "" ;;
        thunderbird|mail) echo "" ;;
        nautilus|thunar|*file*) echo "" ;;
        gimp) echo "" ;;
        inkscape) echo "" ;;
        blender) echo "󰂫" ;;
        *draw*) echo "" ;;
        vim|nvim|neovim) echo "" ;;
        emacs) echo "" ;;
        *) echo "" ;;
    esac
}

# Get app command to launch
get_app_command() {
    local app_name="$1"

    # Check if there's a .desktop file
    desktop_file=$(find /usr/share/applications ~/.local/share/applications -name "*${app_name,,}*.desktop" 2>/dev/null | head -1)

    if [ -n "$desktop_file" ]; then
        # Extract Exec command from desktop file
        exec_cmd=$(grep "^Exec=" "$desktop_file" | head -1 | cut -d'=' -f2- | sed 's/%.//')
        echo "$exec_cmd"
    else
        # Fallback: just use the app name as command
        echo "$app_name"
    fi
}

# Query database for top 10 apps from past 7 days
query_top_apps() {
    sqlite3 "$DB_PATH" <<EOF
SELECT
    app_name,
    SUM(active_seconds + passive_seconds) as total_seconds
FROM app_sessions_v2
WHERE datetime(started_at) >= datetime('now', '-7 days')
AND ended_at IS NOT NULL
AND app_name NOT IN ('Screensaver', 'hyprlock', 'swaylock')
GROUP BY app_name
ORDER BY total_seconds DESC
LIMIT 10;
EOF
}

# Build menu options
build_menu_options() {
    local apps=()

    while IFS='|' read -r app_name total_seconds; do
        if [ -n "$app_name" ]; then
            icon=$(get_app_icon "$app_name")
            apps+=("$icon  $app_name")
        fi
    done < <(query_top_apps)

    if [ ${#apps[@]} -eq 0 ]; then
        notify-send "App Launcher" "No apps tracked yet. Use your system for a while first."
        exit 1
    fi

    printf '%s\n' "${apps[@]}"
}

# Show menu using walker (Omarchy style)
show_menu() {
    local options
    options=$(build_menu_options)

    if [ -z "$options" ]; then
        exit 1
    fi

    # Use walker in dmenu mode with Omarchy styling
    if command -v omarchy-launch-walker &>/dev/null; then
        echo -e "$options" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 600 -p "Launch…" 2>/dev/null
    elif command -v walker &>/dev/null; then
        echo -e "$options" | walker --dmenu 2>/dev/null
    else
        notify-send "App Launcher" "Walker not found. Install walker first."
        exit 1
    fi
}

# Main
main() {
    selected=$(show_menu)

    if [ -z "$selected" ] || [ "$selected" = "CNCLD" ]; then
        exit 0
    fi

    # Extract app name (remove icon and spaces)
    app_name=$(echo "$selected" | sed -E 's/^[^ ]+ +//')

    # Get launch command
    launch_cmd=$(get_app_command "$app_name")

    if [ -n "$launch_cmd" ]; then
        # Launch the app in the background
        setsid $launch_cmd >/dev/null 2>&1 &
    else
        notify-send "App Launcher" "Could not launch $app_name"
    fi
}

main
